<!DOCTYPE html>
<html lang="en">

<head>
    <title>La FELAcarte</title>
    <meta property="og:description" content="La FELAcarte" />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.js'></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        html,
        body,
        #map {
            height: 100%;
        }

        .maplibregl-popup-content {
            max-width: 400px;
            max-height: 200px;
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            overflow-y: auto;
        }
        .maplibregl-popup-content hr {
            border: 0;
            height: 1px;
            background: #ccc;
            margin: 10px 0;
        }

        .feature-item:hover {
            background-color: #f0f0f0;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
            center: [4, 51],
            zoom: 3
        });

        map.on('load', async () => {
            
            try {
                const imageH = await map.loadImage('hondelatte.png');
                const imageL = await map.loadImage('lantieri.png');

                const imageM = await map.loadImage('mbarki.png');
                const imageD = await map.loadImage('delay.png');

                map.addImage('hondelatte', imageH.data);
                map.addImage('lantieri', imageL.data);

                map.addImage('mbarki', imageM.data);
                map.addImage('delay', imageD.data);


                map.addSource('heatmap-data', {
                    'type': 'geojson',
                    'data': 'fela2.geojson'
                });

                map.addLayer({
                    'id': 'fela-heat',
                    'type': 'heatmap',
                    'source': 'heatmap-data',
                    'maxzoom': 9,
                    'paint': {
                        'heatmap-weight': [
                            'interpolate', ['linear'],
                            ['get', 'mag'],
                            0, 0,
                            6, 1
                        ],
                        'heatmap-intensity': [
                            'interpolate', ['linear'],
                            ['zoom'],
                            0, 1,
                            9, 5
                        ],
                        'heatmap-color': [
                            'interpolate', ['linear'],
                            ['heatmap-density'],
                            0, 'rgba(0, 255, 0, 0)',
                            0.2, 'green',
                            0.4, 'yellow',
                            0.6, 'orange',
                            0.8, 'red'
                        ],
                        'heatmap-radius': [
                            'interpolate', ['linear'],
                            ['zoom'],
                            0, 2,
                            9, 20
                        ],
                        'heatmap-opacity': [
                            'interpolate', ['linear'],
                            ['zoom'],
                            7, 1,
                            9, 0
                        ]
                    }
                }, 'place_city_r6');

                map.addLayer({
                    'id': 'fela-point',
                    'type': 'symbol',
                    'source': 'heatmap-data',
                    'minzoom': 7,
                    'layout': {
                        'icon-image': [
                            'match',
                            ['get', 'presentateur_id'],
                            1, 'hondelatte',
                            2, 'lantieri',
                            3, 'mbarki',
                            4, 'delay',
                            'icon-default' 
                        ],
                        'icon-size': 0.2,
                        'icon-allow-overlap': true,
                        'icon-ignore-placement': true
                    }
                }, 'place_city_r6');

                map.on('click', 'fela-point', (e) => {
                    const feature = e.features[0];


                    const place = e.features[0].properties.lieu;
                    const title = e.features[0].properties.titre;

                    const htmlContent = e.features.map(feature => {
                        const place = feature.properties.lieu;
                        const title = feature.properties.titre;
                        const _id = feature.properties.id

                        return `<div id=${_id}  class="feature-item">
                                <strong>Lieu:</strong> ${place}<br>
                                <strong>Titre:</strong> ${title}<br>
                        </div>`;
                    }).join('<hr>');

                    const popup = new maplibregl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(htmlContent)
                        .addTo(map);

                    const popupElement = popup.getElement();

                    const featureItems = popupElement.querySelectorAll('.feature-item');

                    featureItems.forEach(item => {
                        item.addEventListener('mouseover', (event) => {
                            console.log(`Hovered over item with ID: ${event.currentTarget.id}`);
                            event.currentTarget.style.backgroundColor = '#e9e9e9';
                        });

                        item.addEventListener('mouseout', (event) => {
                            console.log(`Mouse left item with ID: ${event.currentTarget.id}`);
                            event.currentTarget.style.backgroundColor = 'transparent';
                        });
                    });
                });

                map.on('mouseenter', 'fela-point', () => {
                    map.getCanvas().style.cursor = 'pointer';
                });

                map.on('mouseleave', 'fela-point', () => {
                    map.getCanvas().style.cursor = '';
                });
            }
            catch (error) {
                console.error("One or more images failed to load. Map setup aborted.", error);
            }
        });
    </script>
</body>

</html>